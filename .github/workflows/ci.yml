name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cpython-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v1
        with:
          version: 0.15.0

      - name: Build compiler
        run: zig build

      - name: Run CPython unit tests (390 tests)
        run: |
          passed=0
          failed=0
          failed_tests=""
          for f in tests/cpython/test_*.py; do
            if timeout 30 ./zig-out/bin/metal0 "$f" --force >/dev/null 2>&1; then
              passed=$((passed + 1))
            else
              failed=$((failed + 1))
              failed_tests="$failed_tests\n  - $f"
            fi
          done
          echo "CPython tests: $passed passed, $failed failed"
          if [ $failed -gt 0 ]; then
            echo -e "Failed tests:$failed_tests"
            exit 1
          fi
