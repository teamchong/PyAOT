name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ZIG_VERSION: "0.15.0"

jobs:
  # =============================================================================
  # Native Build & Test (Multi-platform)
  # =============================================================================
  build-and-test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, macos-14]  # macos-14 is ARM64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build (debug)
        run: make build

      - name: Run unit tests
        run: make test-unit

      - name: Run integration tests
        run: make test-integration

      - name: Run CPython compatibility tests
        run: make test-cpython

  # =============================================================================
  # Cross-compilation Verification
  # =============================================================================
  cross-compile:
    name: Cross-compile (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-linux-gnu
          - aarch64-linux-gnu
          - x86_64-macos
          - aarch64-macos
          - x86_64-windows-gnu

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cross-compile for ${{ matrix.target }}
        run: zig build -Dtarget=${{ matrix.target }}

  # =============================================================================
  # WASM Build Verification
  # =============================================================================
  build-wasm:
    name: Build (WASM)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build WASM target (wasm32-wasi)
        run: zig build -Dtarget=wasm32-wasi
        continue-on-error: true  # WASM is experimental

      - name: Build WASM target (wasm32-freestanding)
        run: zig build -Dtarget=wasm32-freestanding
        continue-on-error: true  # WASM is experimental

  # =============================================================================
  # Release Build Verification
  # =============================================================================
  build-release:
    name: Build (Release)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v1
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build release binary
        run: make build-release

      - name: Verify binary runs
        run: ./zig-out/bin/metal0 --version || ./zig-out/bin/metal0 --help || true

      - name: Check binary size
        run: |
          ls -lh ./zig-out/bin/metal0
          size ./zig-out/bin/metal0 || true
