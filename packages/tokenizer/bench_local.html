<!DOCTYPE html>
<html>
<head>
    <title>Tokenizer Benchmark - Local</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        h1 { color: #4ec9b0; }
        table { border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #3e3e42; padding: 12px; text-align: left; }
        th { background: #252526; }
        .winner { background: #1e3a20; font-weight: bold; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 0; background: #0e639c; color: white; border: none; cursor: pointer; }
        .loading { color: #4ec9b0; }
        .error { color: #f48771; }
        pre { background: #252526; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üèÜ Tokenizer WASM/JS Benchmark (Local)</h1>
    <p>10,000 iterations on 286-byte text (same as native benchmarks)</p>

    <button onclick="runBenchmark()">Run Benchmark</button>

    <div id="status"></div>
    <div id="results"></div>

    <script type="module">
        const TEXT = "The cat sat on the mat. The dog ran in the park. The bird flew in the sky. The fish swam in the sea. The snake slithered on the ground. The rabbit hopped in the field. The fox ran through the forest. The bear climbed the tree. The wolf howled at the moon. The deer grazed in the meadow.";
        const ITERATIONS = 10000;

        window.runBenchmark = async function() {
            const results = [];
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');

            statusDiv.innerHTML = '<p class="loading">Running benchmarks...</p>';
            resultsDiv.innerHTML = '';

            // Test 1: gpt-tokenizer
            statusDiv.innerHTML += '<p>Testing gpt-tokenizer...</p>';
            try {
                const { encode } = await import('./node_modules/gpt-tokenizer/esm/main.js');

                // Warmup
                for (let i = 0; i < 100; i++) encode(TEXT);

                // Benchmark
                const start = performance.now();
                for (let i = 0; i < ITERATIONS; i++) encode(TEXT);
                const elapsed = performance.now() - start;

                results.push({
                    name: 'gpt-tokenizer',
                    time: Math.round(elapsed),
                    tokens: encode(TEXT).length,
                    type: 'Pure JS'
                });
            } catch (e) {
                results.push({ name: 'gpt-tokenizer', error: e.message });
            }

            // Test 2: tiktoken
            statusDiv.innerHTML += '<p>Testing tiktoken...</p>';
            try {
                const tiktoken = await import('./node_modules/tiktoken/tiktoken.js');
                const enc = tiktoken.getEncoding('cl100k_base');

                // Warmup
                for (let i = 0; i < 100; i++) enc.encode(TEXT);

                // Benchmark
                const start = performance.now();
                for (let i = 0; i < ITERATIONS; i++) enc.encode(TEXT);
                const elapsed = performance.now() - start;

                results.push({
                    name: 'tiktoken (Rust‚ÜíWASM)',
                    time: Math.round(elapsed),
                    tokens: enc.encode(TEXT).length,
                    type: 'WASM'
                });
                enc.free();
            } catch (e) {
                results.push({ name: 'tiktoken', error: e.message });
            }

            // Test 3: ai-tokenizer
            statusDiv.innerHTML += '<p>Testing ai-tokenizer...</p>';
            try {
                const { encode } = await import('./node_modules/ai-tokenizer/dist/index.js');

                // Warmup
                for (let i = 0; i < 100; i++) encode(TEXT);

                // Benchmark
                const start = performance.now();
                for (let i = 0; i < ITERATIONS; i++) encode(TEXT);
                const elapsed = performance.now() - start;

                results.push({
                    name: 'ai-tokenizer',
                    time: Math.round(elapsed),
                    tokens: encode(TEXT).length,
                    type: 'Pure JS'
                });
            } catch (e) {
                results.push({ name: 'ai-tokenizer', error: e.message });
            }

            // Test 4: PyAOT WASM
            statusDiv.innerHTML += '<p>Testing PyAOT WASM...</p>';
            try {
                // Load WASM
                const response = await fetch('./zig-out/bin/tokenizer.wasm');
                const wasmBytes = await response.arrayBuffer();
                const {instance} = await WebAssembly.instantiate(wasmBytes, {});

                // Would need tokenizer JSON here
                results.push({
                    name: 'PyAOT (Zig‚ÜíWASM)',
                    error: 'Needs cl100k_base.json data',
                    size: `${Math.round(wasmBytes.byteLength/1024)}KB WASM`
                });
            } catch (e) {
                results.push({ name: 'PyAOT', error: e.message });
            }

            // Display results
            displayResults(results);
            statusDiv.innerHTML = '<p class="loading">‚úÖ Complete!</p>';
        };

        function displayResults(results) {
            const successful = results.filter(r => !r.error).sort((a, b) => a.time - b.time);
            const fastest = successful[0]?.time || 1;

            let html = `
                <h2>Results (${ITERATIONS} iterations)</h2>
                <table>
                    <tr>
                        <th>Implementation</th>
                        <th>Time</th>
                        <th>vs Fastest</th>
                        <th>Tokens</th>
                        <th>Type</th>
                    </tr>
            `;

            successful.forEach((r, i) => {
                const speedup = (r.time / fastest).toFixed(2);
                const rowClass = i === 0 ? 'winner' : '';
                const trophy = i === 0 ? ' üèÜ' : '';
                html += `
                    <tr class="${rowClass}">
                        <td>${r.name}${trophy}</td>
                        <td>${r.time}ms</td>
                        <td>${speedup}x</td>
                        <td>${r.tokens}</td>
                        <td>${r.type}</td>
                    </tr>
                `;
            });

            // Show errors
            const errors = results.filter(r => r.error);
            errors.forEach(r => {
                const sizeInfo = r.size ? ` (${r.size})` : '';
                html += `
                    <tr>
                        <td>${r.name}</td>
                        <td colspan="4" class="error">${r.error}${sizeInfo}</td>
                    </tr>
                `;
            });

            html += `</table>
                <h3>Native Comparison (60K iterations):</h3>
                <pre>PyAOT (Zig):      741ms üèÜ
TokenDagger (C):  775ms
tiktoken (Rust): 1194ms
HuggingFace:     5240ms</pre>
            `;

            document.getElementById('results').innerHTML = html;
        }
    </script>
</body>
</html>
